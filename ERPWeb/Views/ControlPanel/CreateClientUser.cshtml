
@{
    ViewBag.Title = ViewBag.PageHead;
}
<div class="row" style="margin-top:-15px">
    <div class="col-md-12">
        <div class="card card-navy">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-3">
                        <a href="@Url.Action("ClientUserConfiguration","ControlPanel")" class="btn btn-sm btn-outline-primary" title="Back To List">
                            <i class="fas fa-arrow-circle-left"></i>
                        </a>
                    </div>
                    <div class="col-md-6">
                        <h4 class="text-center text-bold">@ViewBag.PageHead</h4>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-sm btn-outline-primary btn-lg btn-flat float-right" id="btnSubmit">
                            Save...<i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <form id="frmItem">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="Id" id="hdfUserId" value="@ViewBag.Id" />
                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label for="txtEmployeeId" class="control-label font-weight-bold">Employee Id</label>
                                    <input type="text" id="txtEmployeeId" class="form-control form-control-sm" />
                                    <span class="error hide required-employeeId font-weight-bold">Input EmployeeId!</span>
                                    <span class="error hide duplicate-employeeId font-weight-bold">Already EmployeeId Exist!</span>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="txtFullName" class="control-label font-weight-bold">Full Name</label>
                                    <input type="text" id="txtFullName" class="form-control form-control-sm" />
                                    <span class="error hide required-fullName font-weight-bold">Input Full Name!</span>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="txtMobileNo" class="control-label font-weight-bold">Mobile No</label>
                                    <input type="text" id="txtMobileNo" class="form-control form-control-sm" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="txtAddress" class="control-label font-weight-bold">Address</label>
                                    <input type="text" id="txtAddress" class="form-control form-control-sm" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label for="txtEmail" class="control-label font-weight-bold">Email</label>
                                    <input type="email" id="txtEmail" class="form-control form-control-sm" />
                                    <span class="error hide dup-email">Email is already exist!</span>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="txtDesignation" class="control-label font-weight-bold">Designation</label>
                                    <input type="text" id="txtDesignation" class="form-control form-control-sm" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="txtUserName" class="control-label font-weight-bold">
                                        User Name
                                        <div class="checkbox d-inline icheck-emerland">
                                            <input type="checkbox" name="chkStatestatus" id="chkStatestatus" />
                                            <label for="chkStatestatus" class="text-success">
                                                Active
                                            </label>
                                        </div>
                                    </label>
                                    <input type="text" id="txtUserName" class="form-control form-control-sm" />
                                    <span class="error hide required-userName font-weight-bold">Input User Name!</span>
                                    <span class="error hide dup-userName">UserName is already exist!</span>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="txtPassword" class="control-label font-weight-bold">Password</label>
                                    <input type="text" id="txtPassword" class="form-control form-control-sm" />
                                    <span class="error hide required-password font-weight-bold">Input Password!</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label for="txtConfirmPassword" class="control-label font-weight-bold">Confirm Password</label>
                                    <input type="text" id="txtConfirmPassword" class="form-control form-control-sm" />
                                    <span class="error hide required-confirmPassword font-weight-bold">Input Confirm password!</span>
                                    <span class="error hide compare-password font-weight-bold">Password & Confirm Password does not match!</span>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="ddlRoleName" class="control-label font-weight-bold">Role</label>
                                    <select id="ddlRoleName" class="form-control form-control-sm">
                                        <option value="">--Select Role--</option>
                                    </select>
                                    <span class="error hide req-role">Role is required</span>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="ddlBranchName" class="control-label font-weight-bold">Branch</label>
                                    <select id="ddlBranchName" class="form-control form-control-sm">
                                        <option value="">--Select Branch--</option>
                                    </select>
                                    <span class="error hide req-branch">Branch is required</span>
                                </div>

                            </div>
                            <div class="form-row hide">
                                @*<div class="form-group col-md-3">
                                        <div class="form-control form-control-sm">
                                            <input type="checkbox" id="chkStatestatus" /> <b>Is User Active?</b>
                                        </div>
                                    </div>*@
                                <div class="form-group col-md-3 hide">
                                    <div class="form-control form-control-sm">
                                        <input type="checkbox" id="chkStatestatusRole" /> <b>Is Role Active?</b>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="col-md-12" style="max-height:500px;overflow-y:scroll">
                    <table class="table table-sm table-avatar table-responsive-lg" id="tblMenuData">
                        @*<tr class="btn-info">
                                    <td colspan="9" title="Module" class="text-center text-bold text-lg">
                                        Control Panel
                                    </td>
                                </tr>
                            <tr class="text-bold" data-item-name="menurow">
                                    <td title="Mainmenu" class="text-center" style="vertical-align:middle" data-mainmenu-item="" data-module-item="">
                                        User Management
                                    </td>
                                    <td class="btn btn-secondary" title="Submenu"><input type="checkbox" id="submenuId" data-item-sub="" data-item-menu="" data-item-module="" /> Organization List</td>
                                    <td>
                                        <input type="checkbox" data-control-for="action" data-action-for="submenuId" id="allSubmenuId" value="" /> All
                                    </td>
                                    <td >
                                        <input type="checkbox" data-control-for="action" data-action-for="submenuId" id="addSubmenuId" value="" />Add
                                    </td>
                                    <td>
                                        <input type="checkbox" data-control-for="action" data-action-for="submenuId" id="editSubmenuId" value="" /> Edit
                                    </td>
                                    <td>
                                        <input type="checkbox" data-control-for="action" data-action-for="submenuId" id="detailSubmenuId" value="" />Detail
                                    </td>
                                    <td>
                                        <input type="checkbox" data-control-for="action" data-action-for="submenuId" id="deleteSubmenuId" value="" />
                                        Delete
                                    </td>
                                    <td>
                                        <input type="checkbox" data-control-for="action" data-action-for="submenuId" id="approvalSubmenuId" value="" />
                                        Approval
                                    </td>
                                    <td>
                                        <input type="checkbox" data-control-for="action" data-action-for="submenuId" id="reportSubmenuId" value="" />
                                        Report
                                    </td>
                                </tr>*@
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">
        var hdfUserId = $("#hdfUserId");
        var txtEmployeeId = $("#txtEmployeeId");
        var txtFullName = $("#txtFullName");
        var txtMobileNo = $("#txtMobileNo");
        var txtAddress = $("#txtAddress");
        var txtEmail = $("#txtEmail");
        var txtDesignation = $("#txtDesignation");
        var txtUserName = $("#txtUserName");
        var txtPassword = $("#txtPassword");
        var txtConfirmPassword = $("#txtConfirmPassword");
        var ddlRoleName = $("#ddlRoleName");
        var ddlBranchName = $("#ddlBranchName");
        var chkStatestatus = $("#chkStatestatus");
        var chkStatestatusRole = $("#chkStatestatusRole");
        var tblMenuData = $("#tblMenuData");

        var role = "";
        var branch = "";

        $(document).ready(function () {
            
            if (TryParseInt(hdfUserId.val(), 0) > 0) {
                loadAppUserInfo(TryParseInt(hdfUserId.val(), 0));
            }
            else {
                ddlLoad();
            }
        })

        function loadAppUserInfo(id) {
            var data = JSON.stringify({ flag: "load", id: id });
            $.when(postReqWithData(dataType.applicationJson, dataType.json, type.post, '/ControlPanel/CreateAppUser', data)).then(function (res,status) {
                console.log(res);
                if (status === "success") {
                    txtEmployeeId.val(res.EmployeeId);
                    txtFullName.val(res.FullName);
                    txtMobileNo.val(res.MobileNo);
                    txtAddress.val(res.Address);
                    txtEmail.val(res.Email);
                    txtDesignation.val(res.Desigation);
                    txtUserName.val(res.UserName);
                    txtPassword.val(res.Password);
                    txtConfirmPassword.val(res.ConfirmPassword);
                    role = res.RoleId;
                    branch = res.BranchId;
                    ddlLoad();
                    //ddlBranchName.val(res.BranchId);
                    //ddlRoleName.val(res.RoleId);
                    chkStatestatus.prop("checked", res.IsActive);
                    chkStatestatusRole.prop("checked", res.IsRoleActive);
                }
            }).fail(function (error) {
                console.log(error);
            })
        }

        function ddlLoad() {
            clearDropdown("ddlRoleName");
            clearDropdown("ddlBranchName");
            tblMenuData.empty();
             LoadDropDown4('/Common/GetBranchesByOrgId', type.post, ddlBranchName, JSON.stringify({ orgId: '@User.OrgId' }), branch);
             LoadDropDown4('/Common/GetRolesByOrgId', type.post, ddlRoleName, JSON.stringify({ orgId: '@User.OrgId' }), role);
             loadMenu();
        }

        function loadMenu() {
            var data = JSON.stringify({ flag: "userMenus", userId: hdfUserId.val(), orgId: '@User.OrgId' });
            $.when(postReqWithData(dataType.applicationJson, dataType.json, type.post, '/ControlPanel/ClientUserConfiguration', data)).then(function (res, status) {
                if (status === 'success') {
                    console.log(res);
                    SetUserMenuUI(res);
                }
            }).fail(function (error) {
                console.log(error);
            })
        }

        function SetUserMenuUI(obj) {
            if (!$.isEmptyObject(obj)) {

                tblMenuData.empty();

                var menus = obj.menuDetail;
                $.each(menus, function (index, item) {

                    // Module
                    var trModule = "<tr class='alert alert-dark'><td colspan='9' title='Module' class='text-center text-bold text-lg'><b>" + item.ModuleName + "</b></td></tr>";
                    tblMenuData.append(trModule);

                    $.each(item.Menus, function (idx, itm) {
                        // Mainmenu
                        var tr = "";
                        $.each(itm.SubMenus, function (ix, im) {
                            // Submenu

                            var td1 = "<td title='Mainmenu' class='text-center' style='vertical-align:middle' data-mainmenu-item='" + itm.MenuId + "' data-module-item='" + item.ModuleId + "'>" + itm.MenuName + "</td >";

                            var td2 = "<td class='" + (im.TaskId > 0 ? "alert alert-warning" : "alert alert-info") + "' title='Submenu'><input type='checkbox' " + (im.TaskId > 0 ? "checked='checked'" : "") + " id='" + im.SubmenuId + "'data-val-for='submenu' data-item-sub='" + im.SubmenuId + "' data-item-menu='" + itm.MenuId + "' data-item-module='" + item.ModuleId + "' data-item-task='" + im.TaskId + "' data-item-parentsub='" + im.ParentSubMenuId + "' />" + im.SubMenuName + "</td>";

                            var isAll = false;
                            if (im.Add && im.Edit && im.Delete && im.Approval && im.Report) {
                                isAll = true;
                            }
                            var isAllactive = isAll ? 'checked="checked"' : '';
                            var td3 = "<td><input type='checkbox' data-control-for='action' data-action-for='" + im.SubmenuId + "' id='all" + im.SubmenuId + "' " + isAllactive + "/> All";

                            var td4 = "<td><input type='checkbox' data-control-for='action' data-action-for='" + im.SubmenuId + "' id='add" + im.SubmenuId + "' " + (im.Add ? 'checked="checked"' : '') + "/> Add";

                            var td5 = "<td><input type='checkbox' data-control-for='action' data-action-for='" + im.SubmenuId + "' id='edit" + im.SubmenuId + "' " + (im.Edit ? 'checked="checked"' : '') + "/> Edit";

                            var td6 = "<td><input type='checkbox' data-control-for='action' data-action-for='" + im.SubmenuId + "' id='detail" + im.SubmenuId + "' " + (im.Detail ? 'checked="checked"' : '') + "/> Detail";

                            var td7 = "<td><input type='checkbox' data-control-for='action' data-action-for='" + im.SubmenuId + "' id='delete" + im.SubmenuId + "' " + (im.Delete ? 'checked="checked"' : '') + "/> Delete";

                            var td8 = "<td><input type='checkbox' data-control-for='action' data-action-for='" + im.SubmenuId + "' id='approval" + im.SubmenuId + "' " + (im.Approval ? 'checked="checked"' : '') + "/> Approval";

                            var td9 = "<td><input type='checkbox' data-control-for='action' data-action-for='" + im.SubmenuId + "' id='report" + im.SubmenuId + "' " + (im.Report ? 'checked="checked"' : '') + "/> Report";

                            tr += '<tr data-item-name="menurow">' + td1 + td2 + td3 + td4 + td5 + td6 + td7 + td8 + td9 + '</tr>';
                        });
                        if (itm.SubMenus.length == 0) {
                            var td1 = "<td data-mainmenu-id='" + itm.MenuId + "' class='text-center' style='vertical-align: middle'>" + itm.MenuName + "</td>";
                            var td2 = "<td colspan='8'>No Submenus Found.</td>";
                            tr = "<tr data-item-name='menurow'>" + td1 + td2 + "</tr>";
                        }
                        tblMenuData.append(tr);
                    });
                    if (item.Menus.length == 0) {
                        var trMenu = '<tr><td colspan="9" class="text-center">No Menus Found.</td></tr>';
                        tblMenuData.append(trMenu);
                    }
                });
                fixit(tblMenuData);
            }
        }

        function fixit(selector) {
            selector.each(function () {
                var values = $(this).find("tr>td:first-of-type")
                var run = 1
                for (var i = values.length - 1; i > -1; i--) {
                    if (values.eq(i).text() === values.eq(i - 1).text()) {
                        values.eq(i).remove()
                        run++
                    } else {
                        values.eq(i).attr("rowspan", run)
                        run = 1
                    }
                }
            })
        }

        ddlRoleName.change(function () {
            if (TryParseInt(ddlRoleName.val(), 0) > 0) {
                loadMenuByRole('@User.OrgId',ddlRoleName.val());

            } else {
                loadMenu();
            }
        })

        function loadMenuByRole(orgId, roleId) {
            var data = JSON.stringify({ flag: "roleMenus", roleId: roleId, orgId: orgId });
            $.when(postReqWithData(dataType.applicationJson, dataType.json, type.post, '/ControlPanel/ClientUserConfiguration', data)).then(function (res, status) {
                if (status === 'success') {
                    console.log(res);
                    SetUserMenuUI(res);
                }
            }).fail(function (error) {
                console.log(error);
            })
        }

        $(document).on('click', "input[type='checkbox'][data-val-for='submenu']", function (e) {
            var i = $(this).is(':checked')
            console.log('checked...');
            if (i === true) {
                $(this).parent().removeClass('alert alert-info');
                $(this).parent().addClass('alert alert-warning');
            }
            else {
                $(this).parent().removeClass('alert alert-warning');
                $(this).parent().addClass('alert alert-info');
            }
        })

        $(document).on("click", "input[type='checkbox'][id^='all']", function (e) {
            var id = $(this).attr('data-action-for');
            if ($(this).is(":checked")) {
                ////console.log("All is checked");
                $("input[type='checkbox'][data-action-for='" + id + "']").prop("checked", true);
            }
            else {
                ////console.log("All is UnChecked");
                $("input[type='checkbox'][data-action-for='" + id + "']").prop("checked", false);
            }
        })

        $(document).on('click', 'input[type="checkbox"][data-control-for="action"]', function (e) {
            //if ($(this).is(":checked")) {
            var tr = $(this).parent().parents('tr');
            var tdLength = $(this).parent().parents('tr').children('td').length;
            console.log('Tr length=' + tdLength);
            var isReport = (tr.find('td').eq(tdLength - 1).children('input[type="checkbox"]').is(":checked")) == true ? true : false;
            var isApproval = (tr.find('td').eq(tdLength - 2).children('input[type="checkbox"]').is(":checked")) == true ? true : false;
            var isDelete = (tr.find('td').eq(tdLength - 3).children('input[type="checkbox"]').is(":checked")) == true ? true : false;

            var isDetail = (tr.find('td').eq(tdLength - 4).children('input[type="checkbox"]').is(":checked")) == true ? true : false;
            var isEdit = (tr.find('td').eq(tdLength - 5).children('input[type="checkbox"]').is(":checked")) == true ? true : false;
            var isAdd = (tr.find('td').eq(tdLength - 6).children('input[type="checkbox"]').is(":checked")) == true ? true : false;

            if (isReport && isApproval && isDelete && isEdit && isAdd && isDetail) {
                tr.find('td').eq(tdLength - 7).children('input[type="checkbox"][id^="all"]').prop("checked", true);
                //alert('data-control-for 1');
            }
            else {
                tr.find('td').eq(tdLength - 7).children('input[type="checkbox"][id^="all"]').prop("checked", false);
                //alert('data-control-for 2');
            }
            //}
        })

        function validateUserForm() {
            $(".error").addClass("hide");
            var isValid = true;
            if ($.trim(txtEmployeeId.val()) == "") {
                $(".required-employeeId").removeClass("hide");
                isValid = false;
            }
            else {
                var id = TryParseInt(hdfUserId.val(), 0);
                if (ajaxBooleanChecker(JSON.stringify({ id: id, employeeId: txtEmployeeId.val().trim() }), '/Common/IsDuplicateEmployeeId', getToken()) == true) {
                    $(".duplicate-employeeId").removeClass("hide");
                    isValid = false;
                }
            }
            if ($.trim(txtFullName.val()) === "") {
                $(".required-fullName").removeClass("hide");
                isValid = false;
            }
            if ($.trim(txtPassword.val()) === "") {
                $(".required-password").removeClass("hide");
                isValid = false;
            }
            else {
                if ($.trim(txtConfirmPassword.val()) === "") {
                    $(".required-confirmPassword").removeClass("hide");
                    isValid = false;
                }
                else {
                    if ($.trim(txtConfirmPassword.val()) !== $.trim(txtPassword.val())) {
                        $(".compare-password").removeClass("hide");
                        isValid = false;
                    }
                }
            }
            if ($.trim(txtUserName.val()) === "") {
                $(".required-userName").removeClass("hide");
                isValid = false;
            }
            else {
                if (ajaxBooleanChecker(JSON.stringify({ userName: txtUserName.val().trim(), id: TryParseInt(hdfUserId.val(), 0) }), '/Common/IsUserExist', getToken()) === true) {
                    $('.dup-userName').removeClass('hide');
                    isValid = false;
                }
            }
            if (txtEmail.val().trim() !== '') {
                if (ajaxBooleanChecker(JSON.stringify({ email: txtEmail.val().trim(), id: TryParseInt(hdfUserId.val(), 0) }), '/Common/IsEmailExist', getToken()) === true) {
                    $('.dup-email').removeClass('hide');
                    isValid = false;
                }
            }

            if (TryParseInt(ddlRoleName.val(), 0) === 0) {
                $(".req-role").removeClass("hide");
                isValid = false;
            }
            if (TryParseInt(ddlBranchName.val(), 0) === 0) {
                $(".req-branch").removeClass("hide");
                isValid = false;
            }

            return isValid;
        }

        $("#btnSubmit").click(function (e) {
            e.preventDefault();
            if (validateUserForm()) {
                disable("#btnSubmit");
                var userData ={
                    UserId: TryParseInt(hdfUserId.val(), 0),
                    EmployeeId: txtEmployeeId.val(),
                    FullName: txtFullName.val(),
                    MobileNo: txtMobileNo.val(),
                    Address: txtAddress.val(),
                    Email: txtEmail.val(),
                    Desigation: txtDesignation.val(),
                    UserName: txtUserName.val(),
                    Password: txtPassword.val(),
                    ConfirmPassword: txtConfirmPassword.val(),
                    OrganizationId: TryParseInt('@User.OrgId', 0),
                    BranchId: TryParseInt(ddlBranchName.val(), 0),
                    RoleId: TryParseInt(ddlRoleName.val(), 0),
                    IsActive: chkStatestatus.is(":checked"),
                    IsRoleActive: chkStatestatusRole.is(":checked"),
                };
                var menuData = fnMenuData();
                var data = JSON.stringify({ appUser: userData, models: menuData });
                $.when(postReqWithToken(dataType.applicationJson, dataType.json, type.post, '/ControlPanel/SaveApplicationUser', data, getToken())).then(function (res, status) {
                    if (res === true && status === 'success') {
                        $('.toastrDefaultSuccess').trigger("click");
                        $('.toastrDefaultSuccess').fadeOut(500);
                         setTimeout(function () {
                            redirectPage('@Url.Action("ClientUserConfiguration")');
                        }, 1000);
                    }
                    else {
                        $('.toastrDefaultError').trigger("click");
                        $('.toastrDefaultError').fadeOut(500);
                    }
                    enable("#btnSubmit");
                }).fail(function (error) {
                    console.log(error);
                    enable("#btnSubmit");
                })
            }
        })

        function redirectPage(page) {
            window.location.replace(page);
        }

        function fnMenuData() {
            var dataAry = [];
            dataAry.length = 0;
            tblMenuData.each(function () {
                //console.log('Inside Loop');
                var trs = $(this).find('tr[data-item-name="menurow"]');
                ////console.log(trs);
                $.each(trs, function (index, item) {
                    var tdLength = $(item).children('td').length;
                    var i = tdLength === 9 ? 1 : 0;
                    if (($(item).find('td').eq((0 + i)).children('input[type="checkbox"]').is(":checked")) == true) {
                        //console.log('Checked....');
                        var submenuId = $(item).find('td').eq((0 + i)).children('input[type="checkbox"]').attr('data-item-sub');
                        var mainmenuId = $(item).find('td').eq((0 + i)).children('input[type="checkbox"]').attr('data-item-menu');
                        var moduleId = $(item).find('td').eq((0 + i)).children('input[type="checkbox"]').attr('data-item-module');
                        var taskId = $(item).find('td').eq((0 + i)).children('input[type="checkbox"]').attr('data-item-task');
                        var parentId = $(item).find('td').eq((0 + i)).children('input[type="checkbox"]').attr('data-item-parentsub');
                        var add = $(item).find('td').eq((2 + i)).children('input[type="checkbox"]').is(":checked");
                        var edit = $(item).find('td').eq((3 + i)).children('input[type="checkbox"]').is(":checked");
                        var detail = $(item).find('td').eq((4 + i)).children('input[type="checkbox"]').is(":checked");
                        var del = $(item).find('td').eq((5 + i)).children('input[type="checkbox"]').is(":checked");
                        var approval = $(item).find('td').eq((6 + i)).children('input[type="checkbox"]').is(":checked");
                        var rpt = $(item).find('td').eq((7 + i)).children('input[type="checkbox"]').is(":checked");

                        dataAry.push({
                            TaskId: taskId,
                            UserId: TryParseInt(hdfUserId.val(), 0),
                            RoleId: 0,
                            ModuleId: moduleId,
                            MainmenuId: mainmenuId,
                            SubmenuId: submenuId,
                            ParentSubmenuId: parentId,
                            Add: add,
                            Edit: edit,
                            Detail: detail,
                            Delete: del,
                            Approval: approval,
                            Report: rpt,
                            OrganizationId: TryParseInt('@User.OrgId', 0)
                        })
                    }
                    console.log(tdLength);
                })
                console.log(dataAry);
            })
            return dataAry;
        }
    </script>

}