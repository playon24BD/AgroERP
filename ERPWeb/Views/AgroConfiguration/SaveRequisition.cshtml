
@{
    ViewBag.Title = "SaveRequisition";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row" style=" margin-top: -25px">
    <div class="col-md-12">
        <div class="card card-navy">
            <div class="card-header" style="text-align: center;">

                <div class="row">
                   
                    <div class="col-md-12">
                       
                        <button class="btn btn-success btn-sm btn float-right" id="btnSubmit">SAVE <i class="fas fa-paper-plane"></i></button>
                        <h5 class="text-center text-bold">

                            Raw Material Requistion
                        </h5>
                    </div>
                    

                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <input type="text" id="hdrawMaterialRequisitionInfoId" class="hide" />
                    <div class="col-md-2">
                        <label class="control-label" for="ddlRawMaterial">RawMaterial</label>
                        @Html.DropDownList("ddlRawMaterial", (IEnumerable<SelectListItem>)ViewBag.ddlRawMaterial, "--Select RawMaterial--", new { @class = "form-control form-control-sm ctrl-changed select2 select2-danger" })
                        <span class="error hide req-ddlRawMaterial">RawMaterial Is Required</span>
                    </div>

                    <div class="col-md-2">
                        <label for="unitName">Unit</label>
                        <input type="text" id="txtUnitName" name="unitName" class="form-control form-control-sm" readonly />
                    </div>
                    <div class="hide">
                        <label for="unitID">UnitID</label>
                        <input type="text" id="hdUnitId" name="unitID" class="form-control form-control-sm" readonly />
                    </div>

                    <div class="col-md-2">
                        <label for="requistionQuantity">Requisition Qty</label>
                        <input type="number" id="numRequisitonQuantity" name="requistionQuantity" class="form-control form-control-sm" />
                        <span class="error hide req-qty">Qty Is Required</span>
                        <span id="spanRawMaterialStockQty">Stock: <span id="RawMaterialStockQty">0</span> </span>
                        <span class="error hide req-qtyChecking">Quantity Must be less than or equal material Qty</span>
                    </div>

                    <div class="col-md-2">
                        <label for="txtRemarks">Remarks</label>
                        <input type="text" id="txtRemarks" name="txtRemarks" class="form-control form-control-sm" />
                    </div>


                    <div class="col-md-2">
                        <label for="" class="control-label font-weight-bold" style="visibility:hidden"> Add To List</label>
                        <div class="clearfix">
                            <button type="submit" class="btn btn-sm btn-outline-warning" id="addTolist"><i class="fas fa-plus"></i> &nbsp; ADD TO LIST </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-12" style="margin-top:-10px">
        <div class="card">
            <div class="card-body">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-12" style="overflow-y:scroll">
                            <table class="table table-bordered table-sm text-sm table-striped table-responsive-lg" id="tblRawMaterialRequisiton">
                                <thead>
                                    @*<tr>
                                        <th colspan="6">
                                            <button class="btn btn-outline-success btn-sm float-lg-right" id="btnSubmit">SAVE <i class="fas fa-paper-plane"></i> </button>
                                        </th>
                                    </tr>*@
                                    <tr class="btn-dark">
                                        <th>#SL</th>
                                        <th>Raw Material</th>
                                        <th>Unit</th>
                                        <th>Requisition Qty</th>
                                        <th>Remarks</th>
                                        <th>Action</th>

                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

@section scripts{
    <script type="text/javascript">

        var ddlRawMaterial = $("#ddlRawMaterial");
        var hdrawMaterialRequisitionInfoId = $("#hdrawMaterialRequisitionInfoId");
        var numRequisitonQuantity = $("#numRequisitonQuantity");
        var txtRemarks = $("#txtRemarks");
        var txtUnitName = $("#txtUnitName");
        var hdUnitId = $("#hdUnitId");
        var rawMaterialList = [];
        var searchByAny = $("#searchByAny");
        var searchByAnyy = $("#searchByAnyy");
        var RawMaterialStockQty = $("#RawMaterialStockQty");




        $(document).ready(function () {
            $('.select2').select2();
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });
            $("#btnSubmit").hide();
            $("#spanRawMaterialStockQty").hide();

            //LoadDataTableStock();
            //LoadDataTable();




        })
        ddlRawMaterial.change(function () {
            RawMaterialStockQty.show();

            $("#spanRawMaterialStockQty").show();


            var data = { RawMaterialId: ddlRawMaterial.val() };

            $.when(getReqWithData('Html', "Get", "/AgroConfiguration/RawMaterialStockLoadUnitName", data)).then(function (res, status) {
                consoleLog(res.replace(/['"]+/g, ''));
                var unit = res.replace(/['"]+/g, '');
                txtUnitName.val(res.UnitName);
                txtUnitName.val(unit);

            });
            $.when(getReqWithData('Html', "Get", "/AgroConfiguration/RawMaterialStockLoadUnitID", data)).then(function (res, status) {
                consoleLog(res.replace(/['"]+/g, ''));
                var unit = res.replace(/['"]+/g, '');
                hdUnitId.val(res.UnitIDd);
                hdUnitId.val(unit);

            });

            $.when(getReqWithData('Html', "Get", "/AgroConfiguration/GetStockQty", data)).then(function (res, status) {
                consoleLog(res.replace(/['"]+/g, ''));
                $('#RawMaterialStockQty').text(res);

            });

        })


        $("#addTolist").click(function (e) {

            e.preventDefault();


            if (validateAddToList()) {

                if (rawMaterialList.includes(ddlRawMaterial.val())) {
                    toastrErrorAlert("Material Already Exist");
                }
                else {
                    var sl = $("#tblRawMaterialRequisiton tbody tr").length;
                    var td1 = "<td class='text-center'><b>" + (sl + 1) + "</b></td>"
                    var td2 = "<td class='text-center'>" + dropDownSelectedText("ddlRawMaterial") + "</td>";
                    var td3 = "<td class='text-center'>" + txtUnitName.val() + "</td>";
                    var td4 = "<td class='text-center QuanityIDCell'>" + numRequisitonQuantity.val() + "</td>";
                    var td8 = "<td class='text-center' >" + txtRemarks.val() + "</td>";
                    var td5 = "<td class='text-center'><a href='#' class='btn btn-sm btn-danger data-onfly-del'><i class='far fa-trash-alt'></i> Delete</a></td>";
                    var td6 = "<td class='text-center hide'>" + ddlRawMaterial.val() + "</td>";
                    var td7 = "<td class='text-center hide'>" + hdUnitId.val() + "</td>";
                    var tr = "<tr>" + td1 + td2 + td3 + td4 +td8+ td5 + td6 + td7 + "</tr>";

                    $("#tblRawMaterialRequisiton tbody").append(tr);
                    $("#spanRawMaterialStockQty").hide();
                    rawMaterialList.push(ddlRawMaterial.val());
                    $("#btnSubmit").show();

                    clearCtrl();

                }

            }

        })


        function clearCtrl() {
            ddlRawMaterial.val("");
            ddlRawMaterial.trigger("change");
            txtUnitName.val("");
            hdUnitId.val("0");
            txtRemarks.val("");
            numRequisitonQuantity.val("0");
            RawMaterialStockQty.val("");
        }
        function validateAddToList() {
     
            var isValid = true;
            $(".error").addClass('hide');

            if ($.trim(ddlRawMaterial.val()) == 0) {
                $(".req-ddlRawMaterial").removeClass('hide');
                isValid = false;
            }
            if (TryParseInt(numRequisitonQuantity.val(), 0) <= 0) {
                $(".req-qty").removeClass('hide');
                isValid = false;
            }
            if (QuantityCheck() == true) {
                $(".req-qtyChecking").removeClass('hide');
                isValid = false;
            }

            return isValid;
        }

        function QuantityCheck() {

            var isValid = false;
            var originalQty = RawMaterialStockQty.text();
            var qty = originalQty.replace(/\(|\)/g, '');
            console.log(qty);
            if (TryParseInt(numRequisitonQuantity.val()) > qty) {
                isValid = true
            }
            return isValid;
        }


        $(document).on("click", "a.data-onfly-del", function (e) {

            e.preventDefault();
            var index = $(this).parent().parents('tbody tr').index();
            var tds = $(this).parent().parents('tbody tr').children('td');


            var rId = tds.eq(5).html();
      
            const mid = rawMaterialList.indexOf(rId);

            rawMaterialList.splice(mid, 1);

            if (bootbox.confirm("Are you sure you want to delete?", function (result) {
                if (result === true) {
                    removeTableRow("#tblRawMaterialRequisiton tbody", index);
                    fnFixTheTbodyRowSerial("#tblRawMaterialRequisiton tbody", index);

                };
            }));

        })


        $("#btnSubmit").click(function (e) {
            e.preventDefault();
            var info = { RawMaterialRequisitionInfoId: TryParseInt(hdrawMaterialRequisitionInfoId.val(), 0) };
            var details = [];

            $.each($("#tblRawMaterialRequisiton tbody tr"), function (index, item) {
                var tds = $(this).children('td');
                details.push({
                    RawMaterialIssueStockDetailId: 0,
                    RawMaterialId: tds.eq(6).html(),
                    UnitID: tds.eq(7).html(),
                    RequisitionQuantity: tds.eq(3).html(),
                    Remarks: tds.eq(4).html(),
                });
            })

           info.rawMaterialRequisitionDetailsDTO = details;
            var data = JSON.stringify({ info });
            $.when(postReqWithToken(dataType.applicationJson, dataType.json, 'POST', '/AgroConfiguration/SaveRequisition', data, getToken())
            ).then(function (res, status) {

                if (res === true) {

                                $('.toastrDefaultSuccess').trigger('click');
                                setTimeout(function () {
                                    redirectPage('@Url.Action("GetRequisitionProduction")');
                                }, 500);
                            }
                            else {
                                $('.toastrDefaultError').trigger('click');
                            }
                            enable("#btnSubmit");
                        }).fail(function (error) {
                            alert(execuStatus.fail);
                            enable("#btnSubmit");
                        })




        })

        function redirectPage(page) {
            window.location.replace(page);
        }

    </script>

}

